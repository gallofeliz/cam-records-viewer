<!DOCTYPE html>
<html>
<head>
    <title></title>
    <style type="text/css">
        #viewer {
            width: 768px;
            margin: auto;
            position: relative;
            background: #bbb;
            padding: 10px;
        }
        #viewer img {
            width: 768px;
            height: 432px;
        }
        #frame {
            display: block;
            width: 768px;
        }
        #control {
            margin-top: 15px;
            margin-bottom: 0px;
            font-size: 30px;
            padding-inline-start: 0px;
            text-align: center;
        }
        #control li {
            display: inline-block;
            cursor: pointer;
        }
        .hide {
            display: none;
        }
        #loader {
            position: absolute;
            left: 50%;
            top: 410px;
            color: #ddd;
        }
        .calendar {
            width: 106px;
        }
        #camera {
            margin-right: 10px;
        }
        #speed {
            width: 36px;
        }
        #speed-icon {
            margin-left: 10px;
        }
    </style>
</head>
<body>

    <div id="viewer">
        <span id="loader" class="hide">...</span>
        <img />
        <input type="range" id="frame" name="volume" min="0" max="0">
        <div style="text-align: center; margin-top: 10px;">
            <span>üé•</span>
            <select id="camera"></select>
            <input type="text" id="start" class="calendar" />
            <span>üìÖ</span>
            <input type="text" id="end" class="calendar" />
            <span id="speed-icon">üöÑ</span>
            <input type="number" id="speed" min="1" step="5" />
        </div>
         <ul id="control">
             <li id="previous">‚èÆ</li>
             <li id="next">‚è≠</li>
             <li id="play">‚ñ∂Ô∏è</li>
             <li id="pause">‚è∏Ô∏è</li>
             <li id="reset">‚èπ</li>
         </ul>
    </div>
    <script type="text/javascript" src="moment.js"></script>
    <script type="text/javascript" src="flatpickr.js"></script>
    <link rel="stylesheet" type="text/css" href="flatpickr.css">
    <script type="text/javascript">

        (async () => {
            const start = document.querySelector('#start')
            const end = document.querySelector('#end')
            const camera = document.querySelector('#camera')
            const speed = document.querySelector('#speed')

            speed.value = 25

            start.value = moment().startOf('day').format();
            end.value = moment().format();

            flatpickr(start, {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                maxDate: new Date,
                time_24hr: true
            });

            flatpickr(end, {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                maxDate: new Date,
                time_24hr: true
            });

            start.onchange = load
            end.onchange = load
            camera.onchange = load

            let images = [];
            let i = 0;

            const cameras = (await (await fetch('./cameras.json')).json())

            cameras.forEach(cam => {
                const opt = document.createElement('option')
                opt.value = cam
                opt.innerText = cam
                camera.appendChild(opt)
            })

            async function load(e) {
                startStr = moment(start.value).format()
                endStr = moment(end.value).format()
                cam = camera.value
                images = (await (await fetch('./images.json?camera='+encodeURIComponent(cam)+'&start='+ encodeURIComponent(startStr)+'&end='+ encodeURIComponent(endStr))).json())

                if (images.length === 0) {
                    images.push('https://as2.ftcdn.net/jpg/01/93/78/07/500_F_193780749_TNfDK6nxBjx6CxehzQUcUF8fhc8S6W9P.jpg');
                }
                frame.max = images.length - 1;
                i = 0;
                loadImage()
            }

            load()

            document.onkeydown = (e) => {
                switch(e.keyCode) {
                    case 32:
                        if (playing) {
                            document.querySelector('#pause').click()
                        } else {
                            document.querySelector('#play').click()
                        }
                        break;
                    case 39:
                        document.querySelector('#next').click()
                        break;
                    case 37:
                        document.querySelector('#previous').click()
                }
            }

            const img = document.querySelector('#viewer img')
            const frame = document.querySelector('#frame')
            const loader = document.querySelector('#loader')

            a = 1;
            setInterval(() => {
                if (a === 3) {
                    a = -1;
                }
                loader.innerText = '.'.repeat(++a)
            }, 250)

            frame.onfocus = (e) => {
                e.preventDefault();
                frame.blur()
            }

            frame.onchange = (e) => {
                i = e.target.value;
                loadImage();
            }

            var inputTimeout;

            frame.oninput = (e) => {
                if (inputTimeout) {
                    clearTimeout(inputTimeout);
                }
                inputTimeout = setTimeout(() => {
                    i = e.target.value;
                    loadImage();
                }, 50)
            }


            document.querySelector('#play').onclick = () => {
                if (i === images.length - 1) {
                    i=-1;
                }
                if (i < images.length - 1) {
                    playing = true;
                    i++;
                    loadImage();
                }
            }

            document.querySelector('#pause').onclick = () => {
                playing = false;
            }

            document.querySelector('#reset').onclick = () => {
                playing = false;
                i = 0;
                loadImage()
            }

            document.querySelector('#previous').onclick = () => {
                if (i>0) {
                    i--;
                    loadImage()

                }
            }

            document.querySelector('#next').onclick = () => {
                if (i < images.length - 1) {
                    i++;
                    loadImage()
                }
            }

            var playing = false;
            var lastLoadTime = 0;

            function loadImage() {
                const frameTime = Math.round(1/speed.value*1000);

                if (lastLoadTime + frameTime > (new Date).getTime()) {
                    setTimeout(loadImage, lastLoadTime + frameTime - (new Date).getTime());
                    return;
                }

                img.src=images[i]
                frame.value = i
                loader.classList.remove('hide');
                lastLoadTime = (new Date).getTime();
            }

            img.onload = function () {
                loader.classList.add('hide');
                if (playing && i < images.length - 1) {
                    i++
                    loadImage()
                } else if (playing) {
                    playing = false
                }
            }

        })()

    </script>
</body>
</html>
